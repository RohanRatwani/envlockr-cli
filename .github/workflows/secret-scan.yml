name: EnvLockr Secret Scan

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
      - master
      - develop

jobs:
  scan-secrets:
    runs-on: ubuntu-latest
    name: Scan for exposed secrets
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Run EnvLockr Secret Scanner
        id: scan
        run: |
          # Secret patterns to detect
          echo "üîç Scanning for exposed secrets..."
          
          # Define patterns for common secrets
          PATTERNS=(
            "AKIA[0-9A-Z]{16}"                          # AWS Access Key
            "sk_live_[0-9a-zA-Z]{24,}"                  # Stripe Live Key
            "sk_test_[0-9a-zA-Z]{24,}"                  # Stripe Test Key
            "rk_live_[0-9a-zA-Z]{24,}"                  # Stripe Restricted Key
            "sq0csp-[0-9A-Za-z\\-_]{43}"                # Square Access Token
            "sq0atp-[0-9A-Za-z\\-_]{22}"                # Square OAuth Secret
            "ghp_[0-9a-zA-Z]{36}"                       # GitHub Personal Access Token
            "gho_[0-9a-zA-Z]{36}"                       # GitHub OAuth Token
            "ghs_[0-9a-zA-Z]{36}"                       # GitHub Server Token
            "AIza[0-9A-Za-z\\-_]{35}"                   # Google API Key
            "ya29\\.[0-9A-Za-z\\-_]+"                   # Google OAuth Token
            "[0-9]+-[0-9A-Za-z_]{32}\\.apps\\.googleusercontent\\.com" # Google OAuth Client
            "sk-[a-zA-Z0-9]{48}"                        # OpenAI API Key
            "xoxb-[0-9]{11}-[0-9]{11}-[0-9a-zA-Z]{24}"  # Slack Bot Token
            "xoxp-[0-9]{11}-[0-9]{11}-[0-9a-zA-Z]{24}"  # Slack User Token
            "DIGITALOCEAN[A-Z0-9]{64}"                  # DigitalOcean Token
            "mongodb\\+srv://[^:]+:[^@]+@"              # MongoDB Connection String
            "postgres://[^:]+:[^@]+@"                   # PostgreSQL Connection String
            "mysql://[^:]+:[^@]+@"                      # MySQL Connection String
            "redis://[^:]+:[^@]+@"                      # Redis Connection String
            "Bearer [a-zA-Z0-9\\-._~+/]+=*"             # Bearer Token
            "token[\"']?\\s*[:=]\\s*[\"'][a-zA-Z0-9\\-._~+/]+" # Generic token assignment
            "api[_-]?key[\"']?\\s*[:=]\\s*[\"'][a-zA-Z0-9\\-._~+/]+" # Generic API key
            "password[\"']?\\s*[:=]\\s*[\"'][^\"']+"    # Password assignment
            "secret[\"']?\\s*[:=]\\s*[\"'][a-zA-Z0-9\\-._~+/]+" # Secret assignment
          )
          
          FOUND_SECRETS=false
          FINDINGS_FILE="secret_scan_results.txt"
          > "$FINDINGS_FILE"
          
          # Get list of changed files
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          else
            FILES=$(git diff --name-only HEAD~1 HEAD)
          fi
          
          # Scan each file
          for FILE in $FILES; do
            if [ -f "$FILE" ]; then
              # Skip certain files
              if [[ "$FILE" == *".git"* ]] || [[ "$FILE" == *"node_modules"* ]] || [[ "$FILE" == *".lock"* ]]; then
                continue
              fi
              
              for PATTERN in "${PATTERNS[@]}"; do
                MATCHES=$(grep -inE "$PATTERN" "$FILE" 2>/dev/null || true)
                if [ -n "$MATCHES" ]; then
                  FOUND_SECRETS=true
                  echo "‚ùå Potential secret found in: $FILE" | tee -a "$FINDINGS_FILE"
                  echo "$MATCHES" | while read -r line; do
                    echo "   Line: $line" | tee -a "$FINDINGS_FILE"
                  done
                  echo "" | tee -a "$FINDINGS_FILE"
                fi
              done
            fi
          done
          
          if [ "$FOUND_SECRETS" = true ]; then
            echo "::error::üö® Secrets detected in your code! Please use EnvLockr to manage secrets securely."
            echo ""
            echo "üìö How to fix this:"
            echo "1. Remove the secrets from your code"
            echo "2. Add them to EnvLockr: envlockr add SECRET_NAME"
            echo "3. Use environment variables instead of hardcoded values"
            echo "4. Add sensitive files to .gitignore"
            echo ""
            cat "$FINDINGS_FILE"
            exit 1
          else
            echo "‚úÖ No secrets detected in your changes. Good job!"
            exit 0
          fi

      - name: Comment on PR (if secrets found)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let findings = '';
            try {
              findings = fs.readFileSync('secret_scan_results.txt', 'utf8');
            } catch (err) {
              findings = 'Error reading scan results';
            }
            
            const body = "## üö® EnvLockr Secret Scan Alert\n\n" +
              "**Potential secrets detected in this PR!**\n\n" +
              findings + "\n\n" +
              "### üîí How to fix this:\n\n" +
              "1. **Remove the secrets** from your code\n" +
              "2. **Store them securely** with EnvLockr:\n" +
              "   ```bash\n" +
              "   envlockr add SECRET_NAME\n" +
              "   ```\n" +
              "3. **Use environment variables** in your code instead\n" +
              "4. **Add sensitive files** to `.gitignore`\n\n" +
              "### üìñ Learn more:\n" +
              "- [EnvLockr Documentation](https://github.com/RohanRatwani/envlockr-cli)\n" +
              "- [Why secrets in code are dangerous](https://envlockr.dev)\n\n" +
              "---\n" +
              "*Powered by [EnvLockr](https://github.com/RohanRatwani/envlockr-cli) - Secure your environment variables locally*";

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
